{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bona+Nova+SC:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="icon" href="{% static './multimedia/logo_BC13.ico' %}">
  <title>Biblioteca Comunal 13 :: Usuarios</title>
</head>
<body>
  <header>
    <img src="{% static './multimedia/logo_BC13.png' %}" width="150">
  </header>
  <input type="checkbox" id="menu-toggle">
  <label for="menu-toggle" class="menu-icon">‚ò∞</label>
  <nav class="nav__flex font__white">
    <ul class="bona-nova-sc-regular">
      <li><a href="{% url 'lista_usuarios' %}">Usuarios</a></li>
      <li><a href="{% url 'lista_libros' %}">Libros</a></li>
      <li><a href="{% url 'lista_autores' %}">Autores</a></li>
      <li><a href="{% url 'lista_categorias' %}">Categor√≠as</a></li>
      <li><a href="{% url 'lista_editoriales' %}">Editoriales</a></li>
      <li><a href="{% url 'lista_empleados' %}">Empleados</a></li>
      <li><a href="{% url 'lista_prestamos' %}">Pr√©stamos</a></li>
      <li><a href="{% url 'index' %}">Cerrar sesi√≥n</a></li>
    </ul>
    {% if user.is_authenticated %}
      <p style="font-size: 15px;">¬°Hola, {{ user.nombre }}!üñêÔ∏è</p>
    {% endif %}
  </nav>

  <main>
    <h1 class="bona-nova-sc-bold font__white">Usuarios</h1>
    <div class="register__alldata">
      <h2 class="bona-nova-sc-bold">Filtrar Usuarios</h2>
      <form method="get">
          {{ filtro_form.as_p }}
          <button type="submit">Filtrar</button>
      </form>
    </div>
    <table border="1" class="bona-nova-sc-regular">
      <thead>
        <tr>
          <th><strong>ID</strong></th>
          <th><strong>Usuario</strong></th>
          <th><strong>DNI</strong></th>
          <th><strong>Tel√©fono</strong></th>
          <th><strong>Calle</strong></th>
          <th><strong>Numero Calle</strong></th>
          <th><strong>Casa</strong></th>
          <th><strong>Edificio</strong></th>
          <th><strong>Piso</strong></th>
          <th><strong>Depto</strong></th>
          <th><strong>Creado</strong></th>
          <th><strong>Acci√≥n</strong></th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <tr>
          <td>{{ usuario.id }}</td>
          <td>{{ usuario.nombre_usuario }}</td>
          <td>{{ usuario.dni }}</td>
          <td>{{ usuario.telefono }}</td>
          <td>{{ usuario.calle }}</td>
          <td>{{ usuario.numero_calle }}</td>
          <td>{{ usuario.casa }}</td>
          <td>{{ usuario.edificio }}</td>
          <td>{{ usuario.piso }}</td>
          <td>{{ usuario.departamento_numero_casa }}</td>
          <td>{{ usuario.created_at }}</td>
          <td>
            <button class="open-modal-btn" data-id="{{ usuario.id }}"> üìù </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div style="display: flex; gap: 40px; margin-top: 30px;">
      <div class="register__alldata" style="flex: 1;">
        <h2 class="bona-nova-sc-bold">Registro de Usuario</h2>
        <form method="post" action="{% url 'lista_usuarios' %}">
  {% csrf_token %}
  {% if form.errors %}
  <div class="form-errors" style="color: red; margin-bottom: 20px;">
    <ul>
      {% for field in form %}
        {% for error in field.errors %}
          <li><strong>üõë {{ field.label }}:</strong> {{ error }} </li>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
  <label for="id_nombre_usuario">Nombre:</label>
  {{ form.nombre_usuario }}

  <br><label for="id_dni">DNI:</label>
  {{ form.dni }}

  <br><label for="id_telefono">Tel√©fono:</label>
  {{ form.telefono }}

  <br><label for="id_calle">Direcci√≥n:</label>
  {{ form.calle }}

  <br><label for="id_numero_calle">N√∫mero de calle:</label>
  {{ form.numero_calle }}

  <br><label for="id_casa">Casa:</label>
  {{ form.casa }}

  <br><label for="id_edificio">Edificio:</label>
  {{ form.edificio }}

  <br><label for="id_piso">Piso:</label>
  {{ form.piso }}

  <br><label for="id_departamento_numero_casa">Departamento/N√∫mero de casa:</label>
  {{ form.departamento_numero_casa }}

  <br><button type="submit">Registrar</button>
</form>
      </div>
    </div>

    <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <div id="modal-form-container">
        <!-- El formulario de edici√≥n se cargar√° aqu√≠ -->
      </div>
    </div>
  </div>
  </main>

  <footer>
    <p class="bona-nova-sc-regular align__center">¬©Copyright Biblioteca Comunal 13. Todos los derechos reservados</p>
  </footer>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("modal");
    const formContainer = document.getElementById("modal-form-container");

    document.querySelectorAll(".open-modal-btn").forEach(button => {
      button.addEventListener("click", function () {
        const userId = this.dataset.id;

        fetch(`/usuarios/editar/${userId}/modal/`)
          .then(response => response.text())
          .then(html => {
            formContainer.innerHTML = html;
            modal.style.display = "block";

            const editarForm = document.getElementById("editarUsuarioForm");
            const userId = editarForm.dataset.usuarioId;

            // Enviar el formulario por AJAX
            editarForm.addEventListener("submit", function (e) {
              e.preventDefault();
              const formData = new FormData(editarForm);

              fetch(`/usuarios/editar/${userId}/modal/`, {
                method: "POST",
                body: formData,
                headers: {
                  "X-Requested-With": "XMLHttpRequest"
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert("Usuario actualizado correctamente.");
                  modal.style.display = "none";
                  location.reload();
                } else {
                  let errorHtml = "<ul style='color:red'>";
                  for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                      errorHtml += `<li><strong>${field}:</strong> ${error}</li>`;
                    });
                  }
                  errorHtml += "</ul>";
                  editarForm.prepend(document.createRange().createContextualFragment(errorHtml));
                }
              });
            });

            // Bot√≥n ‚ùå
            const closeBtn = formContainer.querySelector(".close-button");
            if (closeBtn) {
              closeBtn.addEventListener("click", function () {
                modal.style.display = "none";
                location.reload();
              });
            }

            // Bot√≥n Cancelar
            const cancelBtn = formContainer.querySelector(".cancel-button");
            if (cancelBtn) {
              cancelBtn.addEventListener("click", function () {
                modal.style.display = "none";
                location.reload();
              });
            }
          });
      });
    });

    // Cierre al hacer clic fuera del modal
    window.addEventListener("click", function (event) {
      if (event.target === modal) {
        modal.style.display = "none";
        location.reload();
      }
    });
  });
</script>
</body>
</html>
