{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bona+Nova+SC:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="icon" href="{% static './multimedia/logo_BC13.ico' %}">
    <title>Biblioteca Comunal 13 :: Autores</title>
</head>
<body>
  <header>
    <img src="{% static './multimedia/logo_BC13.png' %}" width="150">
  </header>
  <input type="checkbox" id="menu-toggle">
  <label for="menu-toggle" class="menu-icon">‚ò∞</label>
  <nav class="nav__flex font__white">
    <ul class="bona-nova-sc-regular">
      <li><a href="{% url 'lista_usuarios' %}">Usuarios</a></li>
      <li><a href="{% url 'lista_libros' %}">Libros</a></li>
      <li><a href="{% url 'lista_autores' %}">Autores</a></li>
      <li><a href="{% url 'lista_categorias' %}">Categor√≠as</a></li>
      <li><a href="{% url 'lista_editoriales' %}">Editoriales</a></li>
      <li><a href="{% url 'lista_empleados' %}">Empleados</a></li>
      <li><a href="{% url 'lista_prestamos' %}">Pr√©stamos</a></li>
      <li><a href="{% url 'index' %}">Cerrar sesi√≥n</a></li>
    </ul>
    {% if user.is_authenticated %}
    <p style="font-size: 15px;">¬°Hola, {{ user.nombre }}!üñêÔ∏è</p>
    {% endif %}
  </nav>
  <main>
    <h1 class="bona-nova-sc-bold font__white">Autores</h1>
    <div class="register__alldata">
      <h2 class="bona-nova-sc-bold">Filtro</h2>
      <form method="get">
  {{ filtro_form.as_p }}
  <button type="submit">Filtrar</button>
  <a href="{% url 'lista_autores' %}">Limpiar</a>
</form>
    </div>
    <table border="1" class="bona-nova-sc-regular">
  <thead>
    <tr>
      <th><strong>ID</strong></th>
      <th><strong>Autor</strong></th>
      <th><strong>Pa√≠s</strong></th>
      <th><strong>Acci√≥n</strong></th>
    </tr>
  </thead>
  <tbody>
    {%for autor in autores%}
    <tr>
      <td>{{autor.id}}</td>
      <td>{{autor.nombre}}</td>
      <td>{{autor.nacionalidad}}</td>
      <td>
        <button class="open-modal-btn" data-id="{{ autor.id }}"> üìù </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="register__alldata">
  <h2 class="bona-nova-sc-bold">Registro de Autor</h2>
  <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">Guardar</button>
  </form>
</div>
  </main>
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <div id="modal-form-container">
        <!-- El formulario de edici√≥n se cargar√° aqu√≠ -->
      </div>
    </div>
  </div>
  <footer>
    <p class="bona-nova-sc-regular align__center">¬©Copyright Biblioteca Comunal 13.Todos los derechos reservados</p>
  </footer>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("modal");
    const formContainer = document.getElementById("modal-form-container");

    document.querySelectorAll(".open-modal-btn").forEach(button => {
      button.addEventListener("click", function () {
        const autorId = this.dataset.id;

        fetch(`/autores/editar/${autorId}/modal/`)
          .then(response => response.json())
          .then(data => {
            formContainer.innerHTML = data.html;
            modal.style.display = "block";

            const editarForm = document.getElementById("editarForm");

            editarForm.addEventListener("submit", function (e) {
              e.preventDefault();
              const formData = new FormData(editarForm);

              fetch(`/autores/editar/${autorId}/modal/`, {
                method: "POST",
                body: formData,
                headers: {
                  "X-Requested-With": "XMLHttpRequest"
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert("Autor actualizado correctamente.");
                  modal.style.display = "none";
                  location.reload();
                } else {
                  let errorHtml = "<ul style='color:red'>";
                  for (const field in data.errors) {
                    data.errors[field].forEach(error => {
                      errorHtml += `<li><strong>${field}:</strong> ${error}</li>`;
                    });
                  }
                  errorHtml += "</ul>";
                  editarForm.prepend(document.createRange().createContextualFragment(errorHtml));
                }
              });
            });

            const closeBtn = formContainer.querySelector(".close-button");
            if (closeBtn) {
              closeBtn.addEventListener("click", function () {
                modal.style.display = "none";
                location.reload();
              });
            }

            const cancelBtn = formContainer.querySelector(".cancel-button");
            if (cancelBtn) {
              cancelBtn.addEventListener("click", function () {
                modal.style.display = "none";
                location.reload();
              });
            }
          });
      });
    });

    window.addEventListener("click", function (event) {
      if (event.target === modal) {
        modal.style.display = "none";
        location.reload();
      }
    });
  });
</script>
</body>
</html>